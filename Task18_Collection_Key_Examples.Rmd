---
title: "Task18 - Key Examples, perhaps for discussion"
author: Andrew Stein
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
# Introduction
The idea is to identify cases where AFIR theory doesn't match SCIM simulation and understand why and build in tests for this.

# Setup and Read Data
```{r, warning=FALSE, message=FALSE}
source("ams_initialize_script.R")
source("SCIM_calculation.R")  
source("ivsc_2cmt_RR_V1.R")
library(RxODE)
model = ivsc_2cmt_RR_KdT0L0()
dirs$rscript_name = "Task18_Collection_Key_Examples.Rmd"
dirs$filename_prefix= str_extract(dirs$rscript_name,"^Task\\d\\d\\w?_")

data_in = read.csv("results/Task16c_data.csv",stringsAsFactors = FALSE)

data = data_in

assumptions = data %>%
  select(id,AFIR_thy,AFIR_sim,SCIM_simplest_thy,SCIM_adhoc_thy,SCIM_sim,starts_with("assumption")) %>%
  select(-assumption_all) %>%
  arrange(SCIM_sim)
nam = names(assumptions) %>%
  str_replace("^assumption_","")
names(assumptions) = nam

```

# Here we check that rounding errors are no longer a problem
### fixed by setting atol and rtol to 1e-12

```{r, warning = FALSE, message = FALSE}
out = plot_param(data %>% filter(id == 1770) ,model)
kable(out$param)
kable(out$compare)

out = plot_param(data %>% filter(id == 4) ,model)
kable(out$param)
kable(out$compare)

```

# Not a problem, but need to use "correct" Tfold formula
### Fix - For AFIR to predict SCIM, we require Tfold is right

Here, the AFIR equations is actually wrong.  Because the free target T0 is accumulating much more than expected.  Because T is actually accumulating much more than expected by AFIR (keT/keDT ~ 300), because T0 is lower than expected by AFIR, because most of T is bound to its ligand.

In practice, what would happen in this scenario is that, if we didn't have ligand data, we would actually predict greater accumulation.  And then actually, it might turn out that AFIR would be right!  So hmm, maybe the AFIR formula should really have Ttotss/T0 instead of keT/keDT.  

This is actually an interesting story to tell, here.

```{r, warning = FALSE, message = FALSE}
out = plot_param(data %>% filter(id == 1424) ,model)
kable(out$param)
kable(out$compare)
```

# L accumulates.  Causes an error.  
### Fix - Can we include an L accumulation factor?  Rearranging SCIM?

What if we degine:
Lfold = Lss/L0

And then we note that
Lss = L0*Lfold

And that
Kss_TL = L0*T0/TL0

Then, with a bit of rearranging, we have
SCIM = Kd*Lfold/Dss

Is that right?  Or do we get a Tfold too?  Need to think a bit more.


```{r, warning = FALSE, message = FALSE}
out = plot_param(data %>% filter(id == 6) ,model)
kable(out$param)
kable(out$compare)
```

# Case where keTL = 0 and koff_TL is slow
### fix - need the right model, because keTL won't really be zero

Would need two sets of simulations. One with short time (say just a year) and one with long time, to illustrate the point.